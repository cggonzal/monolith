<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CSRF Protection â€” Monolith Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css">
</head>
<body class="guide">
  <header id="page-header">
    <div class="wrapper clearfix">
      <nav id="feature-nav">
        <div class="header-logo">
          <a href="index.html">Monolith Guides</a>
        </div>
      </nav>
    </div>
  </header>
  <main id="main">
    <article>
      <header id="feature">
        <div class="wrapper">
          <h1>CSRF Protection</h1>
          <p>Cross-site request forgery helpers and middleware.</p>
        </div>
      </header>
      <div id="article-body" class="wrapper">
        <p>Monolith ships with a built&#8209;in mechanism to defend against cross&ndash;site request forgery. The helpers in <code>app/csrf/</code> generate a per&ndash;session token and store it in an <code>HttpOnly</code> cookie. This token can be embedded in HTML forms or exposed to JavaScript via a meta tag. <code>app/middleware/CSRFMiddleware</code> validates the token on every mutating request and rejects the request with <code>403&nbsp;Forbidden</code> when validation fails.</p>

        <h2 id="token-storage">Token Generation and Storage</h2>
        <p>The first time a controller calls <code>csrf.GetCSRFTokenForForm</code> or <code>csrf.GetCSRFMetaTag</code>, a random 32&nbsp;byte string is created and written to a cookie named <code>csrf_token</code>. The cookie is marked <code>HttpOnly</code>, uses <code>SameSite=Lax</code> and is sent only over HTTPS connections when available.</p>

        <p>You can retrieve the raw value directly using <code>csrf.GetCSRFToken</code> if needed, but most applications will embed the prepared HTML snippets returned by <code>GetCSRFTokenForForm</code> and <code>GetCSRFMetaTag</code>.</p>

        <h2 id="form-submissions">Using Tokens in Forms</h2>
        <p>Include the hidden field generated by <code>csrf.GetCSRFTokenForForm</code> whenever you render a <code>&lt;form&gt;</code>. Inside a controller:</p>
<pre><code class="highlight go">data := map[string]any{
    "csrf_token": csrf.GetCSRFTokenForForm(w, r),
}
templates.ExecuteTemplate(w, "form.html.tmpl", data)</code></pre>
        <p>In the template output the token field:</p>
<pre><code class="highlight html">&lt;form method="POST" action="/items"&gt;
    {{.csrf_token}}
    &lt;!-- form fields --&gt;
&lt;/form&gt;</code></pre>

        <h2 id="ajax-requests">AJAX Requests</h2>
        <p>For JavaScript clients, expose the token in a meta tag using <code>csrf.GetCSRFMetaTag</code> or <code>csrf.GetCSRFTokens</code>. Read the value and send it in the <code>X-CSRF-Token</code> header with your fetch request:</p>
<pre><code class="highlight go">data := map[string]any{
    "csrf_meta": csrf.GetCSRFMetaTag(w, r),
}
templates.ExecuteTemplate(w, "index.html.tmpl", data)</code></pre>
<pre><code class="highlight html">&lt;head&gt;
    {{.csrf_meta}}
&lt;/head&gt;
&lt;script&gt;
const token = document.querySelector('meta[name="csrf-token"]').content;
fetch('/items', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-CSRF-Token': token,
  },
  body: JSON.stringify({name: 'foo'}),
});
&lt;/script&gt;</code></pre>

        <h2 id="middleware">Middleware Verification</h2>
        <p>Wrap your router with <code>middleware.CSRFMiddleware</code> to enforce protection. The middleware compares the token from the <code>csrf_token</code> cookie with either the <code>csrf_token</code> form field or the <code>X-CSRF-Token</code> header. Safe HTTP methods (<code>GET</code>, <code>HEAD</code>, <code>OPTIONS</code>) bypass this check.</p>
<pre><code class="highlight go">mux := http.NewServeMux()
registerRoutes(mux, staticFiles)
handler := middleware.CSRFMiddleware(mux)</code></pre>
        <p>If the cookie is missing, the request lacks a token, or the values differ, the middleware responds with <code>403&nbsp;Forbidden</code>. With these helpers in place, new applications gain strong CSRF protection by default.</p>
      </div>
    </article>
  </main>
</body>
</html>
