<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>CSRF Protection — Monolith Guides</title>
<link href="stylesheets/style.css" rel="stylesheet" type="text/css"/>
</head>
<body class="guide">
<header id="page-header">
<div class="wrapper clearfix">
<nav id="feature-nav">
<div class="header-logo">
<a href="index.html">Monolith Guides</a>
</div>
</nav>
</div>
</header>
<main id="main">
<article>
<header id="feature">
<div class="wrapper">
<h1>CSRF Protection</h1>
<p>Cross-site request forgery helpers and middleware.</p>
<nav aria-label="Chapter" class="guide-index" id="column-side"><a class="skip-link" href="#article-body" id="chapter-nav-skip-link">Skip to article body</a><h2 class="chapter"><picture aria-hidden="true"><img alt="Chapter Icon" src="images/icon_book-close-bookmark-1.svg"/></picture> Chapters</h2><ol class="chapters"><li><a href="#token-storage">Token Generation and Storage</a></li><li><a href="#form-submissions">Using Tokens in Forms</a></li><li><a href="#ajax-requests">AJAX Requests</a></li><li><a href="#middleware">Middleware Verification</a></li></ol></nav></div>
</header>
<div class="wrapper" id="article-body">
<p>Monolith ships with a built‑in mechanism to defend against cross–site request forgery. The helpers in <code>app/csrf/</code> generate a per–session token and store it in an <code>HttpOnly</code> cookie. This token can be embedded in HTML forms or exposed to JavaScript via a meta tag. <code>app/middleware/CSRFMiddleware</code> validates the token on every mutating request and rejects the request with <code>403 Forbidden</code> when validation fails.</p>
<h2 id="token-storage"><a class="anchorlink" data-turbo="false" href="#token-storage"><span>1.</span> Token Generation and Storage</a></h2>
<p>The first time a controller calls <code>csrf.GetCSRFTokenForForm</code> or <code>csrf.GetCSRFMetaTag</code>, a random 32 byte string is created and written to a cookie named <code>csrf_token</code>. The cookie is marked <code>HttpOnly</code>, uses <code>SameSite=Lax</code> and is sent only over HTTPS connections when available.</p>
<p>You can retrieve the raw value directly using <code>csrf.GetCSRFToken</code> if needed, but most applications will embed the prepared HTML snippets returned by <code>GetCSRFTokenForForm</code> and <code>GetCSRFMetaTag</code>.</p>
<h2 id="form-submissions"><a class="anchorlink" data-turbo="false" href="#form-submissions"><span>2.</span> Using Tokens in Forms</a></h2>
<p>Include the hidden field generated by <code>csrf.GetCSRFTokenForForm</code> whenever you render a <code>&lt;form&gt;</code>. Inside a controller:</p>
<pre><code class="highlight go">data := map[string]any{
    "csrf_token": csrf.GetCSRFTokenForForm(w, r),
}
templates.ExecuteTemplate(w, "form.html.tmpl", data)</code></pre>
<p>In the template output the token field:</p>
<pre><code class="highlight html">&lt;form method="POST" action="/items"&gt;
    {{.csrf_token}}
    &lt;!-- form fields --&gt;
&lt;/form&gt;</code></pre>
<h2 id="ajax-requests"><a class="anchorlink" data-turbo="false" href="#ajax-requests"><span>3.</span> AJAX Requests</a></h2>
<p>For JavaScript clients, expose the token in a meta tag using <code>csrf.GetCSRFMetaTag</code> or <code>csrf.GetCSRFTokens</code>. Read the value and send it in the <code>X-CSRF-Token</code> header with your fetch request:</p>
<pre><code class="highlight go">data := map[string]any{
    "csrf_meta": csrf.GetCSRFMetaTag(w, r),
}
templates.ExecuteTemplate(w, "index.html.tmpl", data)</code></pre>
<pre><code class="highlight html">&lt;head&gt;
    {{.csrf_meta}}
&lt;/head&gt;
&lt;script&gt;
const token = document.querySelector('meta[name="csrf-token"]').content;
fetch('/items', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-CSRF-Token': token,
  },
  body: JSON.stringify({name: 'foo'}),
});
&lt;/script&gt;</code></pre>
<h2 id="middleware"><a class="anchorlink" data-turbo="false" href="#middleware"><span>4.</span> Middleware Verification</a></h2>
<p>Wrap your router with <code>middleware.CSRFMiddleware</code> to enforce protection. The middleware compares the token from the <code>csrf_token</code> cookie with either the <code>csrf_token</code> form field or the <code>X-CSRF-Token</code> header. Safe HTTP methods (<code>GET</code>, <code>HEAD</code>, <code>OPTIONS</code>) bypass this check.</p>
<pre><code class="highlight go">mux := http.NewServeMux()
registerRoutes(mux, staticFiles)
handler := middleware.CSRFMiddleware(mux)</code></pre>
<p>If the cookie is missing, the request lacks a token, or the values differ, the middleware responds with <code>403 Forbidden</code>. With these helpers in place, new applications gain strong CSRF protection by default.</p>
</div>
</article>
</main>
</body>
</html>
